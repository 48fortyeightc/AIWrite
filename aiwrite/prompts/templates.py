"""
Prompt æ¨¡æ¿å®šä¹‰

åŒ…å«å¤§çº²ç”Ÿæˆã€ç« èŠ‚å†™ä½œã€æ¶¦è‰²ã€æ‘˜è¦ç”Ÿæˆç­‰æç¤ºè¯æ¨¡æ¿
"""

from __future__ import annotations

from ..models import Paper, Section

# ============================================================================
# å¤§çº²ç”Ÿæˆ Prompt
# ============================================================================

OUTLINE_SUGGESTION_PROMPT = """ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯è®ºæ–‡å¤§çº²è§„åˆ’ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„è®ºæ–‡æ ‡é¢˜å’Œä¸»è¦ç« èŠ‚ï¼Œç”Ÿæˆè¯¦ç»†çš„å°èŠ‚ç»“æ„ã€‚

## ç”¨æˆ·è¾“å…¥

**è®ºæ–‡æ ‡é¢˜**ï¼š{title}
**ç›®æ ‡æ€»å­—æ•°**ï¼š{target_words} å­—

**ä¸»è¦ç« èŠ‚**ï¼š
{major_sections}

## ä»»åŠ¡

è¯·ä¸ºæ¯ä¸ªä¸»è¦ç« èŠ‚ï¼ˆé™¤æ‘˜è¦/Abstract/å‚è€ƒæ–‡çŒ®å¤–ï¼‰ç”Ÿæˆåˆç†çš„å°èŠ‚ç»“æ„ã€‚

## è¾“å‡ºæ ¼å¼

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ YAML æ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ é¢å¤–è¯´æ˜ï¼š

```yaml
sections:
  - id: ch1
    title: ç¬¬ä¸€ç«  ç»ªè®º
    children:
      - id: ch1.1
        title: ç ”ç©¶èƒŒæ™¯
        target_words: 800
        notes: ä»‹ç»ç ”ç©¶é¢†åŸŸçš„èƒŒæ™¯å’Œç°çŠ¶
      - id: ch1.2
        title: ç ”ç©¶æ„ä¹‰
        target_words: 600
        notes: é˜è¿°ç ”ç©¶çš„ç†è®ºå’Œå®è·µæ„ä¹‰
      # ... æ›´å¤šå°èŠ‚
  - id: ch2
    title: ç¬¬äºŒç«  æ–‡çŒ®ç»¼è¿°
    children:
      # ... å°èŠ‚
```

## æ³¨æ„äº‹é¡¹

1. æ¯ä¸ªå°èŠ‚éœ€è¦æœ‰ idï¼ˆå¦‚ ch1.1ï¼‰ã€titleã€target_wordsï¼ˆå»ºè®®å­—æ•°ï¼‰å’Œ notesï¼ˆå†™ä½œæç¤ºï¼‰
2. æ ¹æ®è®ºæ–‡æ ‡é¢˜ä¸»é¢˜ï¼Œç”Ÿæˆç¬¦åˆå­¦æœ¯è§„èŒƒçš„å°èŠ‚ç»“æ„
3. å°èŠ‚æ•°é‡é€‚ä¸­ï¼Œé€šå¸¸æ¯ç«  3-5 ä¸ªå°èŠ‚
4. å„ç« èŠ‚å­—æ•°åˆ†é…éœ€åˆç†ï¼Œæ€»å’Œæ¥è¿‘ç›®æ ‡å­—æ•° {target_words}
5. æ‘˜è¦ã€Abstractã€è‡´è°¢ã€å‚è€ƒæ–‡çŒ®ç­‰ç‰¹æ®Šç« èŠ‚ä¸éœ€è¦ç»†åˆ†å°èŠ‚
6. ç¡®ä¿è¾“å‡ºæ˜¯æœ‰æ•ˆçš„ YAML æ ¼å¼
"""

# ============================================================================
# ç« èŠ‚è‰ç¨¿å†™ä½œ Promptï¼ˆæŒ‰ç« èŠ‚æ•´ä½“ç”Ÿæˆï¼‰
# ============================================================================

CHAPTER_DRAFT_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯è®ºæ–‡å†™ä½œä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ’°å†™è®ºæ–‡ä¸­ä¸€ä¸ªå®Œæ•´ç« èŠ‚çš„å†…å®¹ã€‚

## è®ºæ–‡ä¿¡æ¯

**æ ‡é¢˜**ï¼š{paper_title}
**å…³é”®è¯**ï¼š{keywords}
**æ€»ä½“ç›®æ ‡å­—æ•°**ï¼š{total_target_words} å­—

## å½“å‰ç« èŠ‚

**ç« èŠ‚æ ‡é¢˜**ï¼š{chapter_title}
**æœ¬ç« ç›®æ ‡å­—æ•°**ï¼š{chapter_target_words} å­—

## æœ¬ç« åŒ…å«çš„å°èŠ‚

{subsections_outline}

## è®ºæ–‡æ•´ä½“ç»“æ„ï¼ˆä¾›å‚è€ƒä¸Šä¸‹æ–‡ï¼‰

{outline_context}

## å·²å®Œæˆçš„å‰åºç« èŠ‚æ‘˜è¦

{previous_chapters_summary}

## ä»»åŠ¡

è¯·ä¸€æ¬¡æ€§æ’°å†™æœ¬ç« èŠ‚çš„**å®Œæ•´å†…å®¹**ï¼ŒåŒ…æ‹¬æ‰€æœ‰å°èŠ‚ã€‚ä½¿ç”¨ LaTeX æ ¼å¼è¾“å‡ºã€‚

## è¾“å‡ºæ ¼å¼

è¯·ç›´æ¥è¾“å‡º LaTeX æ ¼å¼çš„ç« èŠ‚å†…å®¹ï¼Œä¸è¦åŒ…å« \\begin{{document}} ç­‰æ–‡æ¡£ç»“æ„å‘½ä»¤ã€‚

```latex
\\section{{ç« èŠ‚æ ‡é¢˜}}

å¼•è¨€æ®µè½...

\\subsection{{å°èŠ‚1æ ‡é¢˜}}

å°èŠ‚1å†…å®¹...

\\subsection{{å°èŠ‚2æ ‡é¢˜}}

å°èŠ‚2å†…å®¹...
```

## å†™ä½œè¦æ±‚ã€é‡è¦ã€‘

1. **å­—æ•°ä¸¥æ ¼æ§åˆ¶**ï¼š
   - æœ¬ç« å†…å®¹å¿…é¡»æ§åˆ¶åœ¨ {chapter_target_words} å­—ï¼ˆÂ±15%è¯¯å·®èŒƒå›´å†…ï¼‰
   - å®é™…è¾“å‡ºå­—æ•°åº”åœ¨ {min_words} ~ {max_words} å­—ä¹‹é—´
   - è¶…å‡ºèŒƒå›´å°†è¢«è§†ä¸ºä¸åˆæ ¼ï¼Œè¯·ä¸¥æ ¼æŠŠæ§
2. **ä¸€æ¬¡å†™å®Œæ‰€æœ‰å°èŠ‚**ï¼šä¸è¦åˆ†å¼€å†™ï¼Œè¯·å®Œæ•´è¾“å‡ºæœ¬ç« æ‰€æœ‰å°èŠ‚å†…å®¹
3. **ç¦æ­¢ä½¿ç”¨ä»¥ä¸‹è¡¨è¾¾**ï¼š
   - ç¦æ­¢ä½¿ç”¨"é¦–å…ˆ"ã€"å…¶æ¬¡"ã€"å†æ¬¡"ã€"æœ€å"ã€"ç»¼ä¸Šæ‰€è¿°"ç­‰è¿‡æ¸¡å¥—è¯
   - ç¦æ­¢ä½¿ç”¨"æœ¬ç« å°†"ã€"æœ¬èŠ‚å°†"ã€"ä¸‹é¢å°†"ç­‰é¢„å‘Šæ€§è¯­å¥
   - ç¦æ­¢ä½¿ç”¨"å¦‚å›¾Xæ‰€ç¤º"ã€"å¦‚è¡¨Yæ‰€ç¤º"ï¼ˆé™¤éå†™ä½œè¦ç‚¹ä¸­æ˜ç¡®è¦æ±‚æ’å…¥å›¾è¡¨ï¼‰
4. **è¯­è¨€è¦æ±‚**ï¼š
   - ä½¿ç”¨å­¦æœ¯è§„èŒƒçš„ä¸­æ–‡è¡¨è¾¾
   - å¥å¼å¤šæ ·åŒ–ï¼Œé¿å…é‡å¤çš„å¥å‹ç»“æ„
   - æ¯ä¸ªæ®µè½å¼€å¤´ç”¨ä¸åŒçš„æ–¹å¼å¼•å…¥
   - å¤šç”¨å…·ä½“æè¿°ï¼Œå°‘ç”¨ç¬¼ç»Ÿæ¦‚æ‹¬
5. **å†…å®¹è¦æ±‚**ï¼š
   - å„å°èŠ‚ä¹‹é—´å†…å®¹ä¸è¦é‡å¤
   - ä¿æŒé€»è¾‘è¿è´¯ä½†é¿å…æœºæ¢°è¡”æ¥
   - ä½¿ç”¨æœ‰æ•ˆçš„ LaTeX è¯­æ³•
6. **å›¾è¡¨å ä½ç¬¦**ï¼ˆä»…å½“å°èŠ‚çš„ notes ä¸­è¦æ±‚æ’å…¥å›¾è¡¨æ—¶ä½¿ç”¨ï¼‰ï¼š
   - åœ¨éœ€è¦æ’å…¥å›¾ç‰‡çš„åœ°æ–¹ä½¿ç”¨ï¼š{{{{FIGURE:å›¾ç‰‡æ ‡é¢˜:å›¾ç‰‡è¯´æ˜}}}}
   - åœ¨éœ€è¦æ’å…¥è¡¨æ ¼çš„åœ°æ–¹ä½¿ç”¨ï¼š{{{{TABLE:è¡¨æ ¼æ ‡é¢˜:è¡¨æ ¼è¯´æ˜}}}}
   - å›¾è¡¨å ä½ç¬¦åº”æ”¾åœ¨ç›¸å…³æè¿°æ–‡å­—ä¹‹å
   - ä¾‹å¦‚ï¼šæè¿°å®Œç³»ç»Ÿæ¶æ„åï¼Œæ·»åŠ  {{{{FIGURE:ç³»ç»Ÿæ¶æ„å›¾:å±•ç¤ºç³»ç»Ÿæ•´ä½“æ¨¡å—ç»“æ„}}}}
"""

# ä¿ç•™æ—§æ¨¡æ¿ç”¨äºå‘åå…¼å®¹
SECTION_DRAFT_PROMPT = CHAPTER_DRAFT_PROMPT

# ============================================================================
# ç« èŠ‚æ¶¦è‰² Prompt
# ============================================================================

SECTION_REFINE_PROMPT = """ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯è®ºæ–‡æ¶¦è‰²ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ¶¦è‰²å’Œæ”¹è¿›è®ºæ–‡ç« èŠ‚çš„å†…å®¹è´¨é‡ã€‚

## è®ºæ–‡ä¿¡æ¯

**æ ‡é¢˜**ï¼š{paper_title}

## å½“å‰ç« èŠ‚

**ç« èŠ‚æ ‡é¢˜**ï¼š{section_title}

## ç« èŠ‚è‰ç¨¿ï¼ˆLaTeX æ ¼å¼ï¼‰

{draft_content}

## ä»»åŠ¡

è¯·å¯¹è‰ç¨¿è¿›è¡Œæ¶¦è‰²ï¼Œæå‡å­¦æœ¯å†™ä½œè´¨é‡ã€‚ä¸»è¦æ”¹è¿›æ–¹å‘ï¼š

1. è¯­è¨€è¡¨è¾¾ï¼šä¿®æ­£è¯­æ³•é”™è¯¯ï¼Œä½¿è¡¨è¾¾æ›´åŠ è§„èŒƒã€æµç•…
2. é€»è¾‘ç»“æ„ï¼šä¼˜åŒ–æ®µè½ç»„ç»‡ï¼Œå¢å¼ºè®ºè¿°çš„é€»è¾‘æ€§
3. å­¦æœ¯è§„èŒƒï¼šç¡®ä¿ç¬¦åˆå­¦æœ¯å†™ä½œè§„èŒƒ
4. **å»é™¤å¥—è¯**ï¼šåˆ é™¤"é¦–å…ˆ/å…¶æ¬¡/æœ€å"ã€"ç»¼ä¸Šæ‰€è¿°"ç­‰æœºæ¢°è¿‡æ¸¡è¯

## è¾“å‡ºæ ¼å¼

è¯·ç›´æ¥è¾“å‡ºæ¶¦è‰²åçš„ LaTeX æ ¼å¼å†…å®¹ï¼Œä¸è¦æ·»åŠ è§£é‡Šæˆ–è¯´æ˜ã€‚
"""


# ============================================================================
# æ‘˜è¦ç”Ÿæˆ Promptï¼ˆå…¨æ–‡å®Œæˆåç”Ÿæˆï¼‰
# ============================================================================

ABSTRACT_GENERATE_PROMPT = """ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯è®ºæ–‡æ‘˜è¦å†™ä½œä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®è®ºæ–‡å…¨æ–‡å†…å®¹ï¼Œæ’°å†™ä¸€ä¸ªé«˜è´¨é‡çš„ä¸­æ–‡æ‘˜è¦ã€‚

## è®ºæ–‡ä¿¡æ¯

**æ ‡é¢˜**ï¼š{paper_title}
**å…³é”®è¯**ï¼š{keywords}
**ç›®æ ‡æ‘˜è¦å­—æ•°**ï¼š300-500 å­—

## è®ºæ–‡å®Œæ•´å†…å®¹

{full_content}

## ä»»åŠ¡

è¯·æ ¹æ®è®ºæ–‡å…¨æ–‡ï¼Œæ’°å†™ä¸€ä¸ªç²¾ç‚¼å‡†ç¡®çš„ä¸­æ–‡æ‘˜è¦ã€‚

## æ‘˜è¦è¦æ±‚

1. **ç»“æ„å®Œæ•´**ï¼šåŒ…å«ç ”ç©¶èƒŒæ™¯ã€ç ”ç©¶ç›®çš„ã€ç ”ç©¶æ–¹æ³•ã€ä¸»è¦ç»“è®º
2. **è¯­è¨€ç²¾ç‚¼**ï¼šä½¿ç”¨å­¦æœ¯è§„èŒƒè¯­è¨€ï¼Œé¿å…å£è¯­åŒ–è¡¨è¾¾
3. **å†…å®¹å‡†ç¡®**ï¼šå‡†ç¡®æ¦‚æ‹¬è®ºæ–‡æ ¸å¿ƒå†…å®¹å’Œåˆ›æ–°ç‚¹
4. **å­—æ•°æ§åˆ¶**ï¼š300-500å­—

## è¾“å‡ºæ ¼å¼

ç›´æ¥è¾“å‡ºæ‘˜è¦æ­£æ–‡ï¼Œä¸éœ€è¦"æ‘˜è¦"æ ‡é¢˜ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æ ¼å¼ã€‚
"""


# ============================================================================
# è‹±æ–‡æ‘˜è¦ç”Ÿæˆ Prompt
# ============================================================================

ABSTRACT_EN_GENERATE_PROMPT = """ä½ æ˜¯ä¸€ä½å­¦æœ¯è®ºæ–‡ç¿»è¯‘ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸­æ–‡æ‘˜è¦å‡†ç¡®ç¿»è¯‘æˆè‹±æ–‡æ‘˜è¦ã€‚

## è®ºæ–‡ä¿¡æ¯

**è®ºæ–‡æ ‡é¢˜**: {paper_title}
**å…³é”®è¯**: {keywords}

## ä¸­æ–‡æ‘˜è¦åŸæ–‡

{chinese_abstract}

## ä»»åŠ¡

è¯·å°†ä¸Šè¿°ä¸­æ–‡æ‘˜è¦ç¿»è¯‘æˆè‹±æ–‡ã€‚è¿™æ˜¯ä¸€é¡¹**ç¿»è¯‘ä»»åŠ¡**ï¼Œä¸æ˜¯æ”¹å†™ä»»åŠ¡ã€‚

## ç¿»è¯‘è¦æ±‚

1. **å¿ å®åŸæ–‡**ï¼šå‡†ç¡®ç¿»è¯‘ä¸­æ–‡æ‘˜è¦çš„æ¯ä¸€å¥è¯ï¼Œä¸é—æ¼ã€ä¸å¢åŠ å†…å®¹
2. **å­¦æœ¯è‹±è¯­**ï¼šä½¿ç”¨æ­£å¼çš„å­¦æœ¯è‹±è¯­è¡¨è¾¾
3. **ä¸“ä¸šæœ¯è¯­**ï¼šæŠ€æœ¯æœ¯è¯­ä½¿ç”¨æ ‡å‡†çš„è‹±æ–‡è¡¨è¾¾
4. **è‡ªç„¶æµç•…**ï¼šåœ¨å¿ å®åŸæ–‡çš„åŸºç¡€ä¸Šï¼Œç¡®ä¿è‹±æ–‡è¡¨è¾¾åœ°é“è‡ªç„¶
5. **æ ¼å¼å¯¹åº”**ï¼šä¿æŒä¸ä¸­æ–‡æ‘˜è¦ç›¸åŒçš„æ®µè½ç»“æ„

## è¾“å‡ºæ ¼å¼

ç›´æ¥è¾“å‡ºè‹±æ–‡æ‘˜è¦å†…å®¹ï¼Œä¸è¦åŠ "Abstract"æ ‡é¢˜ã€‚
"""


def build_outline_prompt(paper: Paper) -> str:
    """
    æ„å»ºå¤§çº²ç”Ÿæˆ Prompt
    
    Args:
        paper: è®ºæ–‡å¯¹è±¡ï¼ˆåŒ…å«æ ‡é¢˜å’Œä¸»è¦ç« èŠ‚ï¼‰
        
    Returns:
        å®Œæ•´çš„ Prompt å­—ç¬¦ä¸²
    """
    # æ ¼å¼åŒ–ä¸»è¦ç« èŠ‚åˆ—è¡¨
    major_sections_lines = []
    for i, section in enumerate(paper.sections, 1):
        major_sections_lines.append(f"{i}. {section.title}")
    major_sections = "\n".join(major_sections_lines)

    return OUTLINE_SUGGESTION_PROMPT.format(
        title=paper.title,
        target_words=paper.target_words,
        major_sections=major_sections,
    )


def build_chapter_draft_prompt(
    paper: Paper,
    chapter: Section,
    previous_summaries: list[str] | None = None,
) -> str:
    """
    æ„å»ºç« èŠ‚è‰ç¨¿å†™ä½œ Promptï¼ˆæŒ‰ç« èŠ‚æ•´ä½“ç”Ÿæˆï¼‰
    
    Args:
        paper: è®ºæ–‡å¯¹è±¡
        chapter: è¦å†™ä½œçš„ä¸»ç« èŠ‚ï¼ˆlevel=1ï¼‰
        previous_summaries: å‰åºç« èŠ‚çš„å†…å®¹æ‘˜è¦åˆ—è¡¨
        
    Returns:
        å®Œæ•´çš„ Prompt å­—ç¬¦ä¸²
    """
    # ç”Ÿæˆè®ºæ–‡å¤§çº²ä¸Šä¸‹æ–‡
    outline_lines = []
    for s in paper.sections:
        outline_lines.append(f"- {s.title}")
        for child in s.children:
            outline_lines.append(f"  - {child.title}")
    outline_context = "\n".join(outline_lines)

    # ç”Ÿæˆæœ¬ç« å°èŠ‚ç»“æ„ï¼ˆåŒ…å«å›¾ç‰‡ä¿¡æ¯ï¼‰
    subsections_lines = []
    chapter_target = chapter.target_words or 2000
    for i, child in enumerate(chapter.children, 1):
        child_words = child.target_words or 500
        notes = child.notes or ""
        subsections_lines.append(f"{i}. {child.title}")
        subsections_lines.append(f"   - ç›®æ ‡å­—æ•°: {child_words} å­—")
        if notes:
            subsections_lines.append(f"   - å†™ä½œè¦ç‚¹: {notes}")
        # æ·»åŠ å›¾ç‰‡ä¿¡æ¯
        if child.figures:
            for fig in child.figures:
                fig_desc = fig.description or ""
                subsections_lines.append(f"   - éœ€æ’å…¥å›¾ç‰‡: {{{{FIGURE:{fig.caption}:{fig_desc}}}}}")
        # æ·»åŠ è¡¨æ ¼ä¿¡æ¯
        if child.tables:
            for tab in child.tables:
                tab_desc = tab.description or ""
                subsections_lines.append(f"   - éœ€æ’å…¥è¡¨æ ¼: {{{{TABLE:{tab.caption}:{tab_desc}}}}}")
        chapter_target = max(chapter_target, sum(c.target_words or 500 for c in chapter.children))
    
    # ä¹Ÿå¤„ç†ç« èŠ‚æœ¬èº«çš„å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
    if chapter.figures:
        for fig in chapter.figures:
            fig_desc = fig.description or ""
            subsections_lines.append(f"æœ¬ç« éœ€æ’å…¥å›¾ç‰‡: {{{{FIGURE:{fig.caption}:{fig_desc}}}}}")
    if chapter.tables:
        for tab in chapter.tables:
            tab_desc = tab.description or ""
            subsections_lines.append(f"æœ¬ç« éœ€æ’å…¥è¡¨æ ¼: {{{{TABLE:{tab.caption}:{tab_desc}}}}}")
    
    subsections_outline = "\n".join(subsections_lines) if subsections_lines else "ï¼ˆæœ¬ç« æ— ç»†åˆ†å°èŠ‚ï¼‰"

    # å‰åºç« èŠ‚æ‘˜è¦
    if previous_summaries:
        prev_summary = "\n\n".join([f"ã€{i+1}ã€‘{s}" for i, s in enumerate(previous_summaries)])
    else:
        prev_summary = "ï¼ˆè¿™æ˜¯è®ºæ–‡ç¬¬ä¸€ç« ï¼Œæ— å‰åºå†…å®¹ï¼‰"

    # è®¡ç®—å­—æ•°èŒƒå›´ï¼ˆÂ±15%ï¼‰
    min_words = int(chapter_target * 0.85)
    max_words = int(chapter_target * 1.15)

    return CHAPTER_DRAFT_PROMPT.format(
        paper_title=paper.title,
        keywords=", ".join(paper.keywords) if paper.keywords else "æ— ",
        total_target_words=paper.target_words,
        chapter_title=chapter.title,
        chapter_target_words=chapter_target,
        min_words=min_words,
        max_words=max_words,
        subsections_outline=subsections_outline,
        outline_context=outline_context,
        previous_chapters_summary=prev_summary,
    )


def build_section_draft_prompt(
    paper: Paper,
    section: Section,
    outline_context: str | None = None,
) -> str:
    """
    æ„å»ºç« èŠ‚è‰ç¨¿å†™ä½œ Promptï¼ˆå‘åå…¼å®¹ï¼Œè°ƒç”¨æ–°çš„ç« èŠ‚çº§ç”Ÿæˆï¼‰
    
    Args:
        paper: è®ºæ–‡å¯¹è±¡
        section: è¦å†™ä½œçš„ç« èŠ‚
        outline_context: è®ºæ–‡å¤§çº²ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
        
    Returns:
        å®Œæ•´çš„ Prompt å­—ç¬¦ä¸²
    """
    # å‘åå…¼å®¹ï¼šè°ƒç”¨æ–°çš„ç« èŠ‚çº§ç”Ÿæˆ
    return build_chapter_draft_prompt(paper, section)


def build_section_refine_prompt(
    paper: Paper,
    section: Section,
    draft_content: str,
) -> str:
    """
    æ„å»ºç« èŠ‚æ¶¦è‰² Prompt
    
    Args:
        paper: è®ºæ–‡å¯¹è±¡
        section: è¦æ¶¦è‰²çš„ç« èŠ‚
        draft_content: ç« èŠ‚è‰ç¨¿å†…å®¹
        
    Returns:
        å®Œæ•´çš„ Prompt å­—ç¬¦ä¸²
    """
    return SECTION_REFINE_PROMPT.format(
        paper_title=paper.title,
        section_title=section.title,
        draft_content=draft_content,
    )


def build_abstract_prompt(paper: Paper, full_content: str) -> str:
    """
    æ„å»ºæ‘˜è¦ç”Ÿæˆ Prompt
    
    Args:
        paper: è®ºæ–‡å¯¹è±¡
        full_content: è®ºæ–‡å…¨æ–‡å†…å®¹
        
    Returns:
        å®Œæ•´çš„ Prompt å­—ç¬¦ä¸²
    """
    return ABSTRACT_GENERATE_PROMPT.format(
        paper_title=paper.title,
        keywords=", ".join(paper.keywords) if paper.keywords else "æ— ",
        full_content=full_content,
    )


def build_abstract_en_prompt(paper: Paper, chinese_abstract: str) -> str:
    """
    æ„å»ºè‹±æ–‡æ‘˜è¦ç”Ÿæˆ Prompt
    
    Args:
        paper: è®ºæ–‡å¯¹è±¡
        chinese_abstract: ä¸­æ–‡æ‘˜è¦å†…å®¹
        
    Returns:
        å®Œæ•´çš„ Prompt å­—ç¬¦ä¸²
    """
    return ABSTRACT_EN_GENERATE_PROMPT.format(
        paper_title=paper.title,
        keywords=", ".join(paper.keywords) if paper.keywords else "N/A",
        chinese_abstract=chinese_abstract,
    )


# ============================================================================
# å›¾ç‰‡è¯†åˆ« Prompt
# ============================================================================

IMAGE_ANALYSIS_PROMPT = """ä½ æ˜¯ä¸€ä½å­¦æœ¯è®ºæ–‡å›¾ç‰‡åˆ†æä¸“å®¶ã€‚è¯·ä»”ç»†åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œå¹¶ä¸ºå­¦æœ¯è®ºæ–‡å†™ä½œæä¾›è¯¦ç»†çš„æè¿°ã€‚

## è®ºæ–‡ä¿¡æ¯
**è®ºæ–‡æ ‡é¢˜**ï¼š{paper_title}
**å›¾ç‰‡æ ‡é¢˜**ï¼š{figure_caption}
**æ‰€å±ç« èŠ‚**ï¼š{section_title}

## åˆ†æä»»åŠ¡

è¯·åˆ†æè¿™å¼ å›¾ç‰‡å¹¶è¾“å‡ºä»¥ä¸‹å†…å®¹ï¼š

### 1. å›¾ç‰‡å†…å®¹æè¿°
è¯¦ç»†æè¿°å›¾ç‰‡ä¸­å±•ç¤ºçš„å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š
- å›¾ç‰‡ç±»å‹ï¼ˆæ¶æ„å›¾/æµç¨‹å›¾/æ•°æ®å›¾è¡¨/ç•Œé¢æˆªå›¾/å®éªŒç»“æœç­‰ï¼‰
- ä¸»è¦ç»„æˆéƒ¨åˆ†å’Œå…ƒç´ 
- å„éƒ¨åˆ†ä¹‹é—´çš„å…³ç³»

### 2. æŠ€æœ¯ç»†èŠ‚
å¦‚æœå›¾ç‰‡åŒ…å«æŠ€æœ¯å†…å®¹ï¼Œè¯·è¯´æ˜ï¼š
- æ¶‰åŠçš„æŠ€æœ¯æ¦‚å¿µ
- æ•°æ®æˆ–æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰
- é‡è¦çš„æ ‡æ³¨æˆ–è¯´æ˜

### 3. è®ºæ–‡å†™ä½œå»ºè®®
é’ˆå¯¹è¿™å¼ å›¾ç‰‡åœ¨è®ºæ–‡ä¸­çš„ä½¿ç”¨ï¼Œå»ºè®®ï¼š
- åº”è¯¥åœ¨æ­£æ–‡ä¸­å¦‚ä½•å¼•ç”¨å’Œæè¿°è¿™å¼ å›¾
- å¯ä»¥å¼ºè°ƒçš„å…³é”®ç‚¹
- ä¸ä¸Šä¸‹æ–‡å†…å®¹çš„è¡”æ¥æ–¹å¼

## è¾“å‡ºæ ¼å¼
è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆä¸è¦ä½¿ç”¨ Markdown ä»£ç å—ï¼‰ï¼š

ã€å›¾ç‰‡ç±»å‹ã€‘ï¼šï¼ˆå¦‚ï¼šç³»ç»Ÿæ¶æ„å›¾ï¼‰
ã€å†…å®¹æ¦‚è¿°ã€‘ï¼šï¼ˆä¸€å¥è¯æ¦‚æ‹¬å›¾ç‰‡å†…å®¹ï¼‰
ã€è¯¦ç»†æè¿°ã€‘ï¼šï¼ˆ2-3æ®µè¯¦ç»†æè¿°ï¼‰
ã€æŠ€æœ¯è¦ç‚¹ã€‘ï¼šï¼ˆåˆ—å‡º3-5ä¸ªæŠ€æœ¯è¦ç‚¹ï¼‰
ã€å†™ä½œå»ºè®®ã€‘ï¼šï¼ˆå¦‚ä½•åœ¨è®ºæ–‡ä¸­æè¿°è¿™å¼ å›¾ï¼‰
"""


def build_image_analysis_prompt(
    paper_title: str,
    figure_caption: str,
    section_title: str,
) -> str:
    """
    æ„å»ºå›¾ç‰‡åˆ†æ Prompt
    
    Args:
        paper_title: è®ºæ–‡æ ‡é¢˜
        figure_caption: å›¾ç‰‡æ ‡é¢˜
        section_title: æ‰€å±ç« èŠ‚æ ‡é¢˜
        
    Returns:
        å®Œæ•´çš„ Prompt å­—ç¬¦ä¸²
    """
    return IMAGE_ANALYSIS_PROMPT.format(
        paper_title=paper_title,
        figure_caption=figure_caption,
        section_title=section_title,
    )


# ============================================================================
# å¤§çº²åˆå§‹åŒ– Promptï¼ˆæ–°å¢ï¼‰
# ============================================================================

OUTLINE_INIT_PROMPT = """ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯è®ºæ–‡å¤§çº²è§„åˆ’ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1. è§£æç”¨æˆ·æä¾›çš„çº¯æ–‡æœ¬å¤§çº²
2. **æ™ºèƒ½åˆ†ææ¯ä¸ªç« èŠ‚åº”è¯¥é…ä»€ä¹ˆå›¾**ï¼Œå³ä½¿ç”¨æˆ·æ²¡æœ‰æ˜ç¡®æ ‡æ³¨
3. æ ¹æ®å·²æœ‰çš„æœ¬åœ°å›¾ç‰‡ï¼Œå°è¯•åŒ¹é…åˆ°åˆé€‚çš„ç« èŠ‚
4. å¯¹äºé€‚åˆè‡ªåŠ¨ç”Ÿæˆçš„å›¾è¡¨ï¼ˆæµç¨‹å›¾ã€æ¶æ„å›¾ç­‰ï¼‰ï¼Œæä¾› Mermaid ä»£ç 
5. å¯¹äºæ— æ³•åŒ¹é…æˆ–ç”Ÿæˆçš„å›¾ï¼Œç»™å‡ºå»ºè®®è®©ç”¨æˆ·è¡¥å……

## è®ºæ–‡ä¿¡æ¯

**è®ºæ–‡æ ‡é¢˜**ï¼š{paper_title}
**ç›®æ ‡å­—æ•°**ï¼š{target_words}

## ç”¨æˆ·æä¾›çš„å¤§çº²

```
{outline_text}
```

## å·²æœ‰çš„æœ¬åœ°èµ„æº

### å›¾ç‰‡æ–‡ä»¶åŠå…¶å†…å®¹æè¿°
{image_descriptions}

### è¡¨æ ¼æ–‡ä»¶åŠå…¶å†…å®¹
{table_descriptions}

## ä»»åŠ¡

1. è§£æå¤§çº²ï¼Œç”Ÿæˆå®Œæ•´çš„ç»“æ„
2. **ä¸»åŠ¨åˆ†ææ¯ä¸ªå°èŠ‚æ˜¯å¦éœ€è¦é…å›¾**ï¼ˆå³ä½¿ç”¨æˆ·æ²¡æ ‡æ³¨ ğŸ“Œï¼‰
3. å°†å·²æœ‰å›¾ç‰‡æ ¹æ®å†…å®¹æè¿°åŒ¹é…åˆ°åˆé€‚çš„ç« èŠ‚
4. å¯¹äºå¯ä»¥è‡ªåŠ¨ç”Ÿæˆçš„å›¾è¡¨ï¼Œæä¾› Mermaid ä»£ç 
5. å¯¹äºå»ºè®®é…å›¾ä½†æ— æ³•è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ ‡è®°ä¸º"å»ºè®®è¡¥å……"

## å›¾ç‰‡ç±»å‹è¯´æ˜

æ¯å¼ å›¾å¿…é¡»æŒ‡å®šç±»å‹ï¼ˆfig_typeï¼‰ï¼š
- **matched**: å·²æˆåŠŸåŒ¹é…åˆ°ç”¨æˆ·æä¾›çš„æœ¬åœ°å›¾ç‰‡
- **generate**: å¯ä»¥ç”¨ Mermaid è‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚æµç¨‹å›¾ã€æ¶æ„å›¾ã€ERå›¾ã€ç±»å›¾ç­‰ï¼‰
- **suggested**: AI å»ºè®®åœ¨æ­¤å¤„æ”¾å›¾ï¼Œä½†éœ€è¦ç”¨æˆ·è‡ªè¡Œè¡¥å……ï¼ˆå¦‚æˆªå›¾ã€å®ç‰©å›¾ç­‰ï¼‰
- **missing**: ç”¨æˆ·æ˜ç¡®è¦æ±‚æ”¾å›¾ï¼ˆğŸ“Œæ ‡æ³¨ï¼‰ä½†æ— æ³•åŒ¹é…æˆ–ç”Ÿæˆ

## è¾“å‡ºæ ¼å¼

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼š

```json
{{
  "paper": {{
    "title": "è®ºæ–‡æ ‡é¢˜",
    "keywords": ["å…³é”®è¯1", "å…³é”®è¯2", "å…³é”®è¯3", "å…³é”®è¯4", "å…³é”®è¯5"],
    "keywords_en": ["Keyword1", "Keyword2", "Keyword3", "Keyword4", "Keyword5"],
    "target_words": {target_words}
  }},
  "sections": [
    {{
      "id": "ch1",
      "title": "ç¬¬1ç«  ç»ªè®º",
      "level": 1,
      "target_words": 2000,
      "notes": "ç« èŠ‚å†™ä½œæç¤º",
      "children": [
        {{
          "id": "ch1-1",
          "title": "1.1 ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰",
          "level": 2,
          "target_words": 600,
          "notes": "å°èŠ‚å†™ä½œæç¤º"
        }}
      ]
    }},
    {{
      "id": "ch2",
      "title": "ç¬¬2ç«  ç³»ç»Ÿéœ€æ±‚åˆ†æ",
      "level": 1,
      "target_words": 2500,
      "children": [
        {{
          "id": "ch2-1",
          "title": "2.1 ç³»ç»Ÿä¸šåŠ¡æµç¨‹",
          "level": 2,
          "target_words": 500,
          "figures": [
            {{
              "id": "fig2-1",
              "fig_type": "matched",
              "path": "img/ä¸šåŠ¡æµç¨‹å›¾.png",
              "caption": "ç³»ç»Ÿä¸šåŠ¡æµç¨‹å›¾",
              "suggestion": null
            }},
            {{
              "id": "fig2-2",
              "fig_type": "generate",
              "path": null,
              "caption": "ç”¨æˆ·ç™»å½•æµç¨‹å›¾",
              "suggestion": "æ ¹æ®éœ€æ±‚åˆ†æç”Ÿæˆ",
              "can_generate": true,
              "mermaid_code": "graph TD\\n    A[å¼€å§‹] --> B[è¾“å…¥è´¦å·å¯†ç ]\\n    B --> C{{éªŒè¯}}\\n    C -->|æˆåŠŸ| D[è¿›å…¥ç³»ç»Ÿ]\\n    C -->|å¤±è´¥| E[æç¤ºé”™è¯¯]\\n    E --> B"
            }}
          ]
        }},
        {{
          "id": "ch2-2",
          "title": "2.2 ç³»ç»ŸåŠŸèƒ½åˆ†æ",
          "level": 2,
          "target_words": 600,
          "figures": [
            {{
              "id": "fig2-3",
              "fig_type": "suggested",
              "path": null,
              "caption": "ç³»ç»ŸåŠŸèƒ½ç•Œé¢æˆªå›¾",
              "suggestion": "å»ºè®®æ’å…¥ç³»ç»Ÿä¸»ç•Œé¢æˆªå›¾ï¼Œå±•ç¤ºåŠŸèƒ½å¸ƒå±€",
              "can_generate": false
            }}
          ]
        }},
        {{
          "id": "ch2-3",
          "title": "2.3 æ•°æ®æµåˆ†æ",
          "level": 2,
          "target_words": 400,
          "figures": [
            {{
              "id": "fig2-4",
              "fig_type": "missing",
              "path": null,
              "caption": "æ•°æ®æµå›¾",
              "suggestion": "ç”¨æˆ·æ ‡æ³¨éœ€è¦æ’å›¾ğŸ“Œï¼Œè¯·æä¾›æ•°æ®æµå›¾æˆ–è®©ç³»ç»Ÿç”Ÿæˆ",
              "can_generate": true,
              "mermaid_code": "æ ¹æ®éœ€è¦ç”Ÿæˆçš„ä»£ç "
            }}
          ]
        }},
        {{
          "id": "ch3-3",
          "title": "3.3 æ•°æ®åº“è®¾è®¡",
          "level": 2,
          "tables": [
            {{
              "id": "tab3-1",
              "path": "tables/ç”¨æˆ·è¡¨.xlsx",
              "caption": "ç”¨æˆ·ä¿¡æ¯è¡¨",
              "source": "local"
            }}
          ]
        }}
      ]
    }}
  ]
}}
```

## æ³¨æ„äº‹é¡¹

1. **ä¸»åŠ¨åˆ†æ**ï¼šå³ä½¿ç”¨æˆ·æ²¡æœ‰ç”¨ğŸ“Œæ ‡æ³¨ï¼Œä¹Ÿè¦åˆ¤æ–­å“ªäº›å°èŠ‚é€‚åˆé…å›¾
2. **ä¼˜å…ˆåŒ¹é…**ï¼šæœ‰æœ¬åœ°å›¾ç‰‡èƒ½åŒ¹é…çš„ä¼˜å…ˆä½¿ç”¨ï¼Œç±»å‹è®¾ä¸º matched
3. **æ™ºèƒ½ç”Ÿæˆ**ï¼šæµç¨‹å›¾ã€æ¶æ„å›¾ã€ERå›¾ã€ç±»å›¾ã€ç”¨ä¾‹å›¾ç­‰é€‚åˆç”¨ Mermaid ç”Ÿæˆ
4. **å»ºè®®è¡¥å……**ï¼šæˆªå›¾ã€å®ç‰©å›¾ã€ç…§ç‰‡ç­‰æ— æ³•è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œè®¾ä¸º suggested å¹¶ç»™å‡ºå»ºè®®
5. **ğŸ“Œæ ‡æ³¨å¤„ç†**ï¼šç”¨æˆ·æ˜ç¡®æ ‡æ³¨ğŸ“Œçš„ä½ç½®ï¼Œå¦‚æœæ— æ³•åŒ¹é…æˆ–ç”Ÿæˆï¼Œè®¾ä¸º missing
6. è¡¨æ ¼åº”æ”¾åœ¨æ•°æ®åº“è®¾è®¡æˆ–éœ€æ±‚è¯´æ˜ç›¸å…³ç« èŠ‚
7. ä¸ºæ¯ä¸ªç« èŠ‚å’Œå°èŠ‚åˆ†é…åˆç†çš„ç›®æ ‡å­—æ•°
8. notes å­—æ®µåº”åŒ…å«è¯¥å°èŠ‚çš„å†™ä½œè¦ç‚¹æç¤º
9. mermaid_code ä¸­çš„æ¢è¡Œä½¿ç”¨ \\n è¡¨ç¤º
10. **Mermaid è¯­æ³•è§„èŒƒ**ï¼š
    - æµç¨‹å›¾/åŠŸèƒ½ç»“æ„å›¾/ç”¨ä¾‹å›¾ï¼šä½¿ç”¨ `graph TD` æˆ– `flowchart TD`
    - æ—¶åºå›¾ï¼šä½¿ç”¨ `sequenceDiagram`
    - ERå›¾ï¼šä½¿ç”¨ `erDiagram`
    - ç±»å›¾ï¼šä½¿ç”¨ `classDiagram`
    - çŠ¶æ€å›¾ï¼šä½¿ç”¨ `stateDiagram-v2`
    - **ç¦æ­¢ä½¿ç”¨** `use case` è¯­æ³•ï¼ˆMermaid ä¸æ”¯æŒï¼‰
    - ç”¨ä¾‹å›¾åº”ä½¿ç”¨ flowchart å®ç°ï¼Œç”¨åœ†è§’çŸ©å½¢è¡¨ç¤ºç”¨ä¾‹ï¼Œç”¨äººå½¢å›¾æ ‡è¡¨ç¤ºè§’è‰²
"""


MERMAID_GENERATION_PROMPT = """ä½ æ˜¯ä¸€ä¸ª Mermaid å›¾è¡¨ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆ Mermaid ä»£ç ã€‚

## è®ºæ–‡ä¿¡æ¯
**è®ºæ–‡æ ‡é¢˜**ï¼š{paper_title}

## éœ€è¦ç”Ÿæˆçš„å›¾è¡¨
**å›¾è¡¨ç±»å‹**ï¼š{diagram_type}
**å›¾è¡¨æ ‡é¢˜**ï¼š{diagram_caption}
**æ‰€å±ç« èŠ‚**ï¼š{section_title}
**å›¾è¡¨æè¿°**ï¼š{diagram_description}

## è¦æ±‚

1. ç”Ÿæˆçš„ Mermaid ä»£ç è¦ä¸è®ºæ–‡ä¸»é¢˜ç›¸å…³
2. ä½¿ç”¨ä¸­æ–‡æ ‡ç­¾
3. ç»“æ„æ¸…æ™°ï¼Œå¸ƒå±€åˆç†
4. åªè¾“å‡º Mermaid ä»£ç ï¼Œä¸è¦å…¶ä»–è¯´æ˜

## æ”¯æŒçš„å›¾è¡¨ç±»å‹ï¼ˆå¿…é¡»ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼‰

- `graph TD` æˆ– `flowchart TD`: æµç¨‹å›¾ã€åŠŸèƒ½ç»“æ„å›¾
- `flowchart LR`: ç”¨ä¾‹å›¾ï¼ˆç”¨åœ†è§’çŸ©å½¢(())è¡¨ç¤ºç”¨ä¾‹ï¼Œç”¨å›¾æ ‡è¡¨ç¤ºè§’è‰²ï¼‰
- `sequenceDiagram`: æ—¶åºå›¾
- `erDiagram`: ER å›¾
- `classDiagram`: ç±»å›¾
- `pie`: é¥¼å›¾
- `xychart-beta`: æŸ±çŠ¶å›¾/æŠ˜çº¿å›¾
- `stateDiagram-v2`: çŠ¶æ€å›¾

## é‡è¦è¯­æ³•è§„åˆ™

1. **ç¦æ­¢ä½¿ç”¨** `use case` è¯­æ³•ï¼ŒMermaid ä¸æ”¯æŒ
2. **èŠ‚ç‚¹æ ‡ç­¾å†…ç¦æ­¢ä½¿ç”¨ \\n æ¢è¡Œ**ï¼Œå¦‚éœ€æ¢è¡Œè¯·ç”¨ `<br>` å¹¶ç”¨å¼•å·åŒ…è£¹æ ‡ç­¾
   - é”™è¯¯ï¼š`A[ç¬¬ä¸€è¡Œ\nç¬¬äºŒè¡Œ]`
   - æ­£ç¡®ï¼š`A["ç¬¬ä¸€è¡Œ<br>ç¬¬äºŒè¡Œ"]`
3. ç”¨ä¾‹å›¾è¯·ç”¨ flowchart å®ç°ï¼š
   ```
   flowchart LR
       Admin([ç®¡ç†å‘˜]) --> UC1((ç”¨æˆ·ç®¡ç†))
       User([æ™®é€šç”¨æˆ·]) --> UC2((ç™»å½•ç³»ç»Ÿ))
   ```
3. èŠ‚ç‚¹å†…å®¹å«ç‰¹æ®Šå­—ç¬¦æ—¶ç”¨å¼•å·åŒ…è£¹
4. ä¸­æ–‡æ ‡ç­¾æ­£å¸¸ä½¿ç”¨ï¼Œæ— éœ€è½¬ä¹‰

## è¾“å‡º

è¯·ç›´æ¥è¾“å‡º Mermaid ä»£ç ï¼š
"""


def build_outline_init_prompt(
    paper_title: str,
    target_words: int,
    outline_text: str,
    image_descriptions: str,
    table_descriptions: str,
) -> str:
    """
    æ„å»ºå¤§çº²åˆå§‹åŒ– Prompt
    
    Args:
        paper_title: è®ºæ–‡æ ‡é¢˜
        target_words: ç›®æ ‡å­—æ•°
        outline_text: ç”¨æˆ·è¾“å…¥çš„å¤§çº²æ–‡æœ¬
        image_descriptions: å›¾ç‰‡æè¿°åˆ—è¡¨
        table_descriptions: è¡¨æ ¼æè¿°åˆ—è¡¨
        
    Returns:
        å®Œæ•´çš„ Prompt å­—ç¬¦ä¸²
    """
    return OUTLINE_INIT_PROMPT.format(
        paper_title=paper_title,
        target_words=target_words,
        outline_text=outline_text,
        image_descriptions=image_descriptions,
        table_descriptions=table_descriptions,
    )


def build_mermaid_generation_prompt(
    paper_title: str,
    diagram_type: str,
    diagram_caption: str,
    section_title: str,
    diagram_description: str,
) -> str:
    """
    æ„å»º Mermaid ä»£ç ç”Ÿæˆ Prompt
    """
    return MERMAID_GENERATION_PROMPT.format(
        paper_title=paper_title,
        diagram_type=diagram_type,
        diagram_caption=diagram_caption,
        section_title=section_title,
        diagram_description=diagram_description,
    )

